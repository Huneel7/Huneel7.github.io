---
title: "Dashboard: NYC Restaurant Inspections"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    source: embed
    theme: sandstone
---

```{r}
library(p8105.datasets)
library(tidyverse)
library(plotly)
library(lubridate)
```

```{r}
data("rest_inspec")
```


```{r}
rest_inspec %>% 
  janitor::clean_names() %>% 
  mutate(inspection_date <- as.Date(inspection_date)) %>%
  filter(inspection_date >= as.Date("2014-01-01"), 
         score != "Missing", boro != "Missing") %>%
  mutate(year = year(inspection_date)) %>%
   plot_ly(x = ~boro, y = ~score, type = "box",
    color = ~boro, frame = ~year, alpha = 0.5) %>% 
  layout(title = "The Distribution of Inspection Score",
         xaxis = list(title = "Borough"),
         yaxis = list(title = "Each Restaurant's Score"))
```


```{r}
rest_inspec %>% 
  janitor::clean_names() %>% 
  mutate(inspection_date <- as.Date(inspection_date)) %>%
  filter(inspection_date >= as.Date("2015-01-01"), 
         score != "Missing", boro != "Missing") %>%
  mutate(year = year(inspection_date)) %>%
  group_by(camis, boro) %>%
  summarise(score_per_rest_by_boro = mean(score)) %>%
   plot_ly(x = ~boro, y = ~score_per_rest_by_boro, type = "box",
    color = ~boro, alpha = 0.5) %>% 
  layout(title = "The Distribution of Inspection Score",
         xaxis = list(title = "Borough"),
         yaxis = list(title = "Each Restaurant's Mean Score (2015-2017)"))

   
```
```{r}
grade_plot_by_boro <- rest_inspec %>% 
  janitor::clean_names() %>% 
  mutate(inspection_date <- as.Date(inspection_date)) %>%
  filter(inspection_date >= as.Date("2014-01-01"), 
         score != "Missing", score >= 0, boro != "Missing") %>%
  mutate(year = year(inspection_date)) %>%
  mutate(grade = case_when(0 <= score & score <= 13 ~ "A",
                         14 <= score & score <= 27 ~ "B",
                         score >= 28 ~ "C")) %>%
  group_by(boro,grade, year) %>%
  summarise(Count = n()) %>%
  rename(Grade = grade) %>%
  ggplot(aes(boro, Count, fill = Grade, frame = year)) + geom_bar(stat  = "identity", position = position_dodge2())

ggplotly(grade_plot_by_boro)


```
```{r}
rest_inspec %>% 
  janitor::clean_names() %>% 
  group_by(violation_code) %>% 
  count(sort = T)


rest_inspec %>%
  filter(violation_code %in% c("08A", "04L")) %>%
  mutate(Date = format(inspection_date, "%Y-%m")) %>%
  group_by(Date, violation_code) %>%
  summarise(count = n()) %>%
  ungroup() %>%
  mutate(violation_code = violation_code %>% fct_relevel("08A", "04L")) %>%
  mutate(violation_code = recode(violation_code, "08A" = "Facility not vermin proof",
                                 "04L" = "Evidence of mice or live mice")) %>%
  plot_ly(x = ~Date, y = ~count,
          color = ~violation_code, type = "scatter", mode = "lines") 
  
```







```{r}
names(rest_inspec)
```

```{r}
skimr::skim(rest_inspec)
```



